---
title: "Gene ID Conversion - 06/29/2025"
author: "Yasmin Hilliam, PhD"
output: html_notebook
---

### Part I: Gene ID Conversion with `org.Hs.eg.db`

`org.Hs.eg.db` is an R package maintained by Bioconductor that provides genome-wide annotation for the human (org.**Hs**.eg.db) genome using Entrez gene identifiers. There are several other packages that provide annotations for other organisms that can be found at https://bioconductor.org/packages/3.21/data/annotation - most are Eukaryotic model organisms but packages for two strains of *E. coli* are also included (K12, `org.EcK12.eg.db`; Sakai, `org.EcSakai.eg.db`).

```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install("org.Hs.eg.db")

library(org.Hs.eg.db) 
```


We can now use this package to create an identifier conversion table that will allow us to convert Ensembl gene IDs. 

```{r}
# show all identifiers available in this dataset
keytypes(org.Hs.eg.db)

# opens the help panel that describes all available identifiers in the database
help("REFSEQ")
```


If we know an individual Ensembl ID, we can use the `select()` function to find out its corresponding identifiers.

```{R}
select(org.Hs.eg.db,
       keys = "ENSG00000108342", # Ensembl ID we want to find identifiers for
       keytype = "ENSEMBL", # tells the function that we are using an Ensembl ID as our reference
       columns = c("ENTREZID","SYMBOL","GENENAME")) # selects the identifiers we are interested in
```


Let's use this function to build our table.

```{r}
keys(org.Hs.eg.db, # keys function returns all entries of the specified keytype
     keytype = "ENSEMBL") -> ensembl_key

length(ensembl_key) # provides the number of identifiers in our key set - 40839 IDs

head(ensembl_key)

# now we can use our vector of Ensembl IDs inside the select function to build a conversion table

select(org.Hs.eg.db,
       keys = ensembl_key,
       keytype = "ENSEMBL",
       columns = c("ENTREZID","SYMBOL","GENENAME")) -> conv_table
```


This output gave us a warning: 

`'select()' returned 1:many mapping between keys and columns`

```{r}
dim(conv_table) # report the dimensions of our conversion table
```


We can see that the length of our conversion table is greater than the number of Ensembl IDs we provided (46112 vs. 40839). This is because some Ensembl IDs map to multiple other identifiers (not uncommon). Let's look at which IDs have duplicate Ensembl IDs.

```{r}
summary(duplicated(conv_table$ENSEMBL))
summary(duplicated(conv_table$ENTREZID))
summary(duplicated(conv_table$SYMBOL))
```


Function `duplicated()` returns a logical vector populated with TRUE or FALSE values that indicate if a value is duplicated. Using `summary()` we can summarize those into a table, as shown above.


```{r}
head(conv_table[duplicated(conv_table$ENSEMBL),]) # view the first six rows of duplicated IDs
```


Let's remove the duplicated IDs from our table

```{r}
conv_table[-c( # -c tells R to remove the following values
  which( # which returns a list of values for which the condition is TRUE
    duplicated( # duplicated returns a logical value
      conv_table$ENSEMBL)==TRUE)),] -> conv_table_unique
```


Now we can check that we have the expected number of Ensembl entries

```{R}
summary(duplicated(conv_table_unique$ENSEMBL)) # no duplicates identified
length(rownames(conv_table_unique)) == length(ensembl_key) # unique table has same number of row names as our list of ensembl IDs
```


### Part II: Gene ID conversion with `biomaRt`

`biomaRt` is a package mainatained by Ensembl.org. As well as an R package, it has a browser interface that allows you to retrieve data online: http://useast.ensembl.org/biomart/martview

Use these IDs to try out the web interface: 

- ENSG00000000971
- ENSG00000004139
- ENSG00000005339

The web interface can be a little slow, especially if you are trying to search large numbers of IDs. Let's use the R package instead. 

```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

BiocManager::install("biomaRt")
library(biomaRt) 
```


Unlike `org.Hs.eg.db`, the `biomaRt` package requires an internet connection to work. First, let's check the available databases.

```{r}
listEnsembl()
```


Let's set the parameters for using the package. We need to specify the database we want to access and the mirror we want to use to access the it. The three available mirrors are "www", "useast", and "asia".

```{r}
useEnsembl(biomart = "genes",
           mirror = "useast") -> ensembl
```


Let's look at the datasets that are available in this database.

```{r}
View(listDatasets(ensembl))
```


We want to look at the human dataset so let's add that into our parameters

```{r}
useEnsembl(biomart = "genes",
           mirror = "useast",
           dataset = "hsapiens_gene_ensembl") -> ensembl
```


Now we can look at the filters (type of query ID) and attrivutes (type of target IDs) to put together a `getBM` function.

```{r}
View(listFilters(ensembl))
```

```{r}
View(listAttributes(ensembl))
```

```{r}
getBM(mart = ensembl,
      values = c("CFTR","CXCL8"),
      filters = "external_gene_name",
      attributes = c("external_gene_name","ensembl_gene_id","description"),
      uniqueRows = TRUE) -> biomart_output

head(biomart_output)
```


### Activities

# Green 1

Use `org.Hs.eg.db` to add a new column with UNIPROT identifiers into your `conv_table` object.

```{r}
select(org.Hs.eg.db,
       keys = ensembl_key,
       keytype="ENSEMBL",
       columns=c("ENTREZID","SYMBOL","GENENAME","UNIPROT")) -> conv_table

conv_table[-c(which(duplicated(conv_table$ENSEMBL)==TRUE)),] -> conv_table_unique

head(conv_table_unique)

summary(duplicated(conv_table_unique$ENSEMBL))
```


# Green 2

Use the `biomaRt` package to add a new attribute UniProtKB/Swiss-Prot into your `biomart_output`. Be sure to examine the output carefully - are the entries unique as we specified? 

```{r}
listFilters(ensembl)

getBM(mart = ensembl,
      values = c("CFTR","CXCL8"),
      filters = "external_gene_name",
      attributes =c("external_gene_name","ensembl_gene_id","description","uniprotswissprot"),
      uniqueRows = TRUE)
```


# Green 3

Use `biomaRt` package to retrieve "ensembl_gene_id", "entrezgene_id", external_gene_name", and "description" information for three IDs of interest.

- ENSG00000000971
- ENSG00000004139
- ENSG00000005339

```{R}
View(listFilters(ensembl))

getBM(mart = ensembl,
      values = c("ENSG00000000971","ENSG00000004139","ENSG00000005339"),
      filters = "ensembl_gene_id",
      attributes = c("ensembl_gene_id","entrezgene_id","ensembl_gene_id","description"),
      uniqueRows = TRUE) -> ensembl_biomart_output
```


# Blue 1

Install and use `org.Mm.eg.db` to create a conversion table object for mouse genes with your chosen identifiers.

```{r}  
BiocManager::install("org.Mm.eg.db")
library(org.Mm.eg.db)

keys(org.Mm.eg.db,
     keytype = "ENSEMBL") -> Mm_key

select(org.Mm.eg.db,
       keys = Mm_key,
       keytype = "ENSEMBL",
       columns = c("ENTREZID","SYMBOL","GENENAME","UNIPROT")) -> Mm_conv_table

Mm_conv_table[-c(which(duplicated(Mm_conv_table$ENSEMBL)==TRUE)),] -> Mm_conv_table_unique

head(Mm_conv_table_unique)

summary(duplicated(Mm_conv_table_unique$ENSEMBL))
```


# Black 1 

Use `org.Hs.eg.db` or `biomaRt` to create an annotation table which has "ENTREZID","SYMBOL","GENENAME" information for all the Ensembl IDs using in `tximport` output. This annotation will be used for the `edgeR` module later in the course. 

Hint: row names of `txi$counts` are Ensembl gene IDs

data_tximport.RDS, the R object file created by `tximport`, is provided if you need it. 

```{r}
readRDS("data_tximport.RDS") -> txi

rownames(txi$counts) -> txi_ensembl

keys(org.Hs.eg.db,
     keytype = "ENSEMBL") -> txi_key

select(org.Hs.eg.db, 
       keys = txi_key, 
       keytype = "ENSEMBL",
       columns=c("ENTREZID","SYMBOL","GENENAME")) -> txi_table

txi_table[-c(which(duplicated(txi_table$ENSEMBL)==TRUE)),] -> txi_table_unique

head(txi_table_unique)

summary(duplicated(txi_table_unique$ENSEMBL))

View(listAttributes(ensembl))

getBM(mart = ensembl,
      values = txi_key,
      filters = "ensembl_gene_id",
      attributes = c("ensembl_gene_id","entrezgene_id","description","external_gene_name","uniprot_gn_symbol"),
      uniqueRows= TRUE) -> txi_biomart
```